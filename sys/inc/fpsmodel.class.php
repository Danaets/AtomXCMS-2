<?php/*---------------------------------------------\|											   || @Author:       Andrey Brykin (Drunya)        || @Version:      1.1                           || @Project:      CMS                           || @Package       AtomX CMS                     || @subpackege    FpsModel class                || @copyright     ©Andrey Brykin 2010-2013      || @last mod      2013/04/25                    ||----------------------------------------------||											   || any partial or not partial extension         || CMS Fapos,without the consent of the         || author, is illegal                           ||----------------------------------------------|| Любое распространение                        || CMS Fapos или ее частей,                     || без согласия автора, является не законным    |\---------------------------------------------*//** * Base class FpsModel. He is parent for all models. * Also he is something like DataMapper and simple Model. */abstract class FpsModel {    /**     * @var string     */	public $Table;    /**     * @var array     */	protected $has_one;    /**     * @var array     */	protected $has_many;    /**     * @var array     */	protected $Binded;    /**     * @var array     */    protected $BindedParams;	    /**     * @param $module     */	public function __construct()	{	}	    public function getTable() {        return $this->Table;    }    public function getTotal($params = array())   	{   		$cnt = $this->getDbDriver()->select($this->Table, DB_COUNT, $params);   		return $cnt;   	}	/**     * @param $id     * @return bool     */	public function getById($id)	{        $Register = Register::getInstance();		$entity = $this->getDbDriver()->select($this->Table, DB_FIRST, array(			'cond' => array(				'id' => $id			)		));		if (!empty($entity[0])) {            $entity = $this->getAllAssigned($entity);			$entityClassName = $Register['ModManager']->getEntityNameFromModel(get_class($this));			$entity = new $entityClassName($entity[0]);			return (!empty($entity)) ? $entity : false;		}		return false;	}	/**     * @return mixed     */	protected function getDbDriver()	{		$Register = Register::getInstance();		return $Register['DB'];	}	/** 	 *     * @param $records     * @return bool     */	protected function getAllAssigned($records)	{		if (empty($records) || count($records) < 1) return false;        if (empty($this->Binded) || !is_array($this->Binded)) return $records;        $Register = Register::getInstance();        //pr($this->RelatedEntities);		// Get all IDs from records		$ids = array();        $hasOneKeys = array();		foreach ($records as $k => $r) {			$ids[$k] = $r['id'];			            // Also we must to collect foreign keys if they exists            if (!empty($this->RelatedEntities)) {                foreach ($this->RelatedEntities as $hok => $hov) {                    if ($hov['type'] !== 'has_one') continue;                    if (!in_array($hok, $this->Binded)) continue;                    if (!array_key_exists($hok, $hasOneKeys)) $hasOneKeys[$hok] = array();										$foreignKey = $hov['foreignKey'];										if (false !== (strpos($foreignKey, 'this.'))) {						$foreignKey = str_replace('this.', '', $foreignKey);					}											if (!empty($r[$foreignKey])) $hasOneKeys[$hok][$k] = $r[$foreignKey];                }            }		}		        // Look through all related tables        if (!empty($this->RelatedEntities)) {            foreach ($this->RelatedEntities as $relKey => $relVal) {							// Get data only from binded tables                if (!in_array($relKey, $this->Binded)) continue;				// has one ...                if ($relVal['type'] === 'has_one') {					$model = $relVal['model'];					if (false !== (strpos($relVal['model'], 'this.'))) {						$field = str_replace('this.', '', $relVal['model']);						$model = $r[$field];					}														// Get model instance and concat IDs                    $oModel = $Register['ModManager']->getModelInstance($model);                    $oids = implode(', ', $hasOneKeys[$relKey]);					$hasOneData = array();					if (!empty($oids)) {						$where = array('`id` IN (' . $oids . ')');						if ($this->getBindParams($relKey)) {							$where = array_merge($where, $this->getBindParams($relKey));						}						$hasOneData = $oModel->getCollection($where);					}										// merge has_one data                    if (is_array($hasOneData) && count($hasOneData)) {                        foreach ($hasOneData as $ok => $ov) {                            foreach ($records as $rk => $rv) {                               if ($rv[$relVal['foreignKey']] == $ov->getId()) {                                   $records[$rk][$relKey] = clone $ov;                                    continue;                               }                            }                        }                    }                // and has_many...                } else if ($relVal['type'] === 'has_many') {                    $mModel = $Register['ModManager']->getModelInstance($relVal['model']);                    $mids = implode(', ', $ids);										$hasManyData = array();					if (!empty($mids)) {						$where = array('`' . $relVal['foreignKey'] . '` IN (' . $mids . ')');												// Merge additional params (We can set this params when bind model)						if ($this->getBindParams($relKey)) {							$where = array_merge($where, $this->getBindParams($relKey));						}												if (!empty($relVal['additionCond'])) {							$where = array_merge($where, $relVal['additionCond']);						}												$hasManyData = $mModel->getCollection($where);					}										// merge has_many data                    if (!empty($hasManyData) && is_array($hasManyData)) {                        foreach ($hasManyData as $mk => $mv) {                            foreach ($records as $rk => $rv) {                               if (!array_key_exists($relKey, $records[$rk])) $records[$rk][$relKey] = array();							                                  if ($rv['id'] == $mv->{'get' . ucfirst($relVal['foreignKey'])}()) {                                   $records[$rk][$relKey][] = clone $mv;                                   continue;                               }                            }                        }                    } else {						foreach ($records as $rk => $rv) {							$records[$rk][$relKey] = array();						}					}                }            }        }        return $records;	}    public function bindModel($attrName, $params = array())    {        if (empty($this->RelatedEntities) || !is_array($this->RelatedEntities)) return false;        foreach ($this->RelatedEntities as $relKey => $relEntity) {            if ($relKey === $attrName) {                $this->Binded[] = $attrName;                if (!empty($params)) $this->setBindParams($attrName, $params);                return true;            }        }        return false;    }    public function getBindParams($attrName = false)    {        if (!$attrName) return $this->BindedParams;        return ($this->BindedParams[$attrName]) ? $this->BindedParams[$attrName] : false;    }	    public function setBindParams($attrName, $params)    {        $this->BindedParams[$attrName] = $params;    }    /**     * @param array $params     * @param array $addParams     * @return array|bool     */    public function getCollection($params = array(), $addParams = array())   	{        $Register = Register::getInstance();        $addParams['cond'] = $params;   		$entities = $this->getDbDriver()->select($this->Table, DB_ALL, $addParams);		   		if (!empty($entities)) {            $entities = $this->getAllAssigned($entities);   			$entityClassName = $Register['ModManager']->getEntityNameFromModel(get_class($this));            foreach ($entities as $key => $entity) {                $entities[$key] = new $entityClassName($entity);            }   			return (!empty($entities)) ? $entities : false;   		}   		return false;   	}    /**     * @return array|bool     */    public function getRelatedEntitiesParams()    {        return (!empty($this->RelatedEntities)) ? $this->RelatedEntities : false;    }				public function getOneField($field, $params)	{		$output = array();		$result = $this->getDbDriver()->select($this->Table, DB_ALL, array(			'cond' => $params,			'fields' => array($field),		));				if (!empty($result)) {			foreach($result as $key => $record) {				$output[] = $record[$field];			}		}				return $output;	}				public function deleteByParentId($id)	{		$Register = Register::getInstance();		$where = array(			'entity_id' => $id,		);		//$records = $Register['DB']->select($this->Table, DB_ALL, array('cond' => $where));		$records = $this->getCollection($where);						if ($records) {			foreach ($records as $k => $v) {				$v->delete();			}		}	}	}